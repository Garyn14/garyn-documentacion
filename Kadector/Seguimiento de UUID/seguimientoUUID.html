<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script>
      class MaquinaEsteganografica {
        constructor() {
          this.bitToChar = { 0: "\u200c", 1: "\u200d" };
          this.charToBit = { "\u200c": "0", "\u200d": "1" };
        }

        codificar(mensajeBase, identificadorUuid) {
          try {
            const hex = identificadorUuid.replace(/-/g, "");
            let binary = "";
            for (let i = 0; i < hex.length; i++) {
              binary += parseInt(hex[i], 16).toString(2).padStart(4, "0");
            }

            let invisiblePayload = "";
            for (let bit of binary) {
              invisiblePayload += this.bitToChar[bit];
            }

            if (mensajeBase.includes(",")) {
              const index = mensajeBase.indexOf(",");
              return (
                mensajeBase.slice(0, index + 1) +
                invisiblePayload +
                mensajeBase.slice(index + 1)
              );
            }
            return mensajeBase + " " + invisiblePayload;
          } catch (e) {
            return mensajeBase;
          }
        }

        decodificar(mensajeRecibido) {
          try {
            let bits = "";
            for (let char of mensajeRecibido) {
              if (this.charToBit[char]) {
                bits += this.charToBit[char];
              }
            }

            if (bits.length < 128) {
              return null;
            }

            const finalBits = bits.slice(-128);

            let hex = "";
            for (let i = 0; i < finalBits.length; i += 4) {
              const chunk = finalBits.slice(i, i + 4);
              hex += parseInt(chunk, 2).toString(16);
            }

            return [
              hex.slice(0, 8),
              hex.slice(8, 12),
              hex.slice(12, 16),
              hex.slice(16, 20),
              hex.slice(20),
            ].join("-");
          } catch (e) {
            console.error("Error al decodificar:", e);
            return null;
          }
        }
      }

      (function () {
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return null;
        }

        function setCookie(name, value, days = 365) {
          const d = new Date();
          d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
          const domain = window.location.hostname
            .split(".")
            .slice(-2)
            .join(".");
          document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/;domain=.${domain};SameSite=Lax;`;
        }

        const params = new URLSearchParams(window.location.search);
        const utms = {};
        for (const [k, v] of params.entries()) {
          if (k.startsWith("utm_") || k === "ttclid") {
            utms[k] = v;
          }
        }

        const KEY = "kdx_lead_id";
        let lead_id = getCookie(KEY);

        if (!lead_id) {
          lead_id = crypto.randomUUID();
          setCookie(KEY, lead_id);
          console.log("Nuevo lead_id creado:", lead_id);
        } else {
          console.log("Lead_id existente:", lead_id);
        }

        const payload = {
          event: "landing_visit",
          lead_id,
          utms,
          landing_url: window.location.href.split("#")[0],
          referrer: document.referrer || "",
          user_agent: navigator.userAgent || "",
          timestamp: new Date().toISOString(),
        };

        fetch("https://n8n.kadector.pe/webhook/web_landing_visit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          keepalive: true,
          mode: "cors",
        }).catch((err) => console.error("Error enviando evento:", err));
      })();

      (function () {
        console.log("SCRIPT TRACKING INICIADO");
        const maquina = new MaquinaEsteganografica();

        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return null;
        }

        window.addEventListener(
          "click",
          function (e) {
            const link = e.target.closest("a");
            if (!link) return;

            const href = link.href || "";
            if (!href.includes("whatsapp") && !href.includes("wa.me")) return;

            console.log("=== CLICK EN WHATSAPP (CON CODIFICACIÓN) ===");

            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            const lead_id = getCookie("kdx_lead_id") || "no-lead-id";

            let urlObj = new URL(href);
            let urlParams = new URLSearchParams(urlObj.search);
            let textoOriginal = urlParams.get("text") || "Hola";

            // codificar UUID
            let textoConIdInvisible = maquina.codificar(textoOriginal, lead_id);

            // Inyeción de texto
            urlParams.set("text", textoConIdInvisible);
            urlObj.search = urlParams.toString();
            const linkFinalCifrado = urlObj.toString();

            const payload = {
              event: "cta_click",
              lead_id: lead_id,
              cta_type: "whatsapp",
              page_url: window.location.href,
              timestamp: new Date().toISOString(),
            };

            console.log("Payload:", JSON.stringify(payload, null, 2));

            navigator.sendBeacon(
              "https://n8n.kadector.pe/webhook/web_cta_click",
              new Blob([JSON.stringify(payload)], { type: "application/json" })
            );

            fetch("https://n8n.kadector.pe/webhook/web_cta_click", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
              keepalive: true,
            }).catch((error) => console.error("Error fetch:", error));

            setTimeout(() => {
              console.log("Abriendo WhatsApp Cifrado...");
              window.open(linkFinalCifrado, "_blank");
            }, 250);

            return false;
          },
          true
        );

        console.log("Event listener configurado");
      })();
    </script>
  </head>
  <body>
    <h1>Kadector Tracking Test</h1>
    <a
      href="https://api.whatsapp.com/send?phone=51924384072&text=Hola, quiero mas informacion de los detectores"
      target="_blank"
      ><b>¡Habla con un experto!</b>
    </a>
  </body>
</html>
